<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Combat Level Benchmark (30 min)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="results/combat/_data.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #fff;
    color: #1a1a1a;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    padding: 24px 32px;
  }
  .page-header { margin-bottom: 4px; }
  .page-header h1 {
    font-size: 22px;
    font-weight: 600;
    color: #1a1a1a;
  }
  .page-subtitle {
    font-size: 14px;
    color: #999;
    margin-bottom: 16px;
  }
  .view-toggle {
    display: inline-flex;
    gap: 0;
    margin-left: 16px;
    vertical-align: middle;
  }
  .view-toggle button {
    padding: 4px 14px;
    background: #fff;
    border: 1px solid #ddd;
    color: #555;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    transition: all 0.15s;
  }
  .view-toggle button:first-child { border-radius: 6px 0 0 6px; }
  .view-toggle button:last-child { border-radius: 0 6px 6px 0; }
  .view-toggle button:not(:first-child) { border-left: none; }
  .view-toggle button.active {
    background: #1a1a1a;
    border-color: #1a1a1a;
    color: #fff;
  }
  .view-toggle button:hover:not(.active) { border-color: #999; color: #1a1a1a; }

  /* Bar chart view */
  .bar-container {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .bar-container canvas {
    width: 100% !important;
    max-width: 800px;
    height: 400px !important;
  }

  /* Runs view */
  .runs-container {
    overflow-x: auto;
  }
  .model-runs-section {
    margin-bottom: 24px;
  }
  .model-runs-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
  }
  .model-runs-header img { width: 18px; height: 18px; }
  .model-runs-header .model-name {
    font-size: 15px;
    font-weight: 600;
  }
  .model-runs-header .model-best {
    font-size: 13px;
    color: #999;
    margin-left: 4px;
  }
  .runs-table {
    border-collapse: collapse;
    width: 100%;
    max-width: 900px;
  }
  .runs-table th, .runs-table td {
    padding: 6px 12px;
    text-align: center;
    font-size: 13px;
    border: 1px solid #e8e8e8;
  }
  .runs-table th {
    background: #fafafa;
    font-weight: 600;
    color: #555;
  }
  .runs-table td.run-num { text-align: center; color: #999; }
  .runs-table td.cl-cell { font-weight: 700; font-size: 15px; }
  .runs-table td.best-run { background: #f0faf0; }
  .runs-table td.error-run { color: #c00; font-style: italic; }
  .runs-table td.skill-cell { font-size: 12px; color: #666; }

  /* Skills heatmap view */
  .skills-container { overflow-x: auto; }
  .skills-table {
    border-collapse: collapse;
    width: 100%;
  }
  .skills-table th, .skills-table td {
    padding: 10px 16px;
    text-align: center;
    font-size: 13px;
    border: 1px solid #e8e8e8;
  }
  .skills-table th {
    background: #fafafa;
    font-weight: 600;
    color: #333;
    position: sticky;
    top: 0;
  }
  .skills-table th.model-header { text-align: left; min-width: 120px; }
  .skills-table td.model-cell {
    text-align: left;
    font-weight: 500;
    color: #333;
    background: #fafafa;
  }
  .heatmap-cell {
    font-weight: 600;
    border-radius: 4px;
    min-width: 64px;
  }
  .heatmap-cell .level-value { font-size: 16px; }
  .heatmap-cell .xp-value {
    font-size: 11px;
    opacity: 0.7;
    margin-top: 2px;
  }

  /* Time-series view */
  .timeseries-container {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .timeseries-container canvas {
    width: 100% !important;
    max-width: 900px;
    height: 450px !important;
  }

  /* Transcript view */
  .transcript-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
    max-width: 960px;
  }
  .transcript-model {
    border: 1px solid #e8e8e8;
    border-radius: 8px;
    overflow: hidden;
  }
  .transcript-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: #fafafa;
    border-bottom: 1px solid #e8e8e8;
    cursor: pointer;
    user-select: none;
  }
  .transcript-header:hover { background: #f0f0f0; }
  .transcript-header img { width: 18px; height: 18px; }
  .transcript-header .model-name { font-size: 14px; font-weight: 600; }
  .transcript-header .model-meta { font-size: 12px; color: #999; margin-left: auto; }
  .transcript-header .expand-icon { color: #999; font-size: 12px; transition: transform 0.2s; }
  .transcript-header.collapsed .expand-icon { transform: rotate(-90deg); }
  .transcript-body { padding: 0; }
  .transcript-body.collapsed { display: none; }
  .transcript-msg {
    padding: 8px 16px;
    font-size: 13px;
    line-height: 1.5;
    color: #333;
    border-bottom: 1px solid #f0f0f0;
    white-space: pre-wrap;
    word-break: break-word;
  }
  .transcript-msg:last-child { border-bottom: none; }
  .transcript-msg-idx {
    display: inline-block;
    min-width: 22px;
    color: #bbb;
    font-size: 11px;
    margin-right: 8px;
    text-align: right;
  }

  /* Legend */
  .bottom-legend {
    display: flex;
    gap: 24px;
    padding: 16px 0 12px;
    flex-wrap: wrap;
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #555;
    cursor: pointer;
  }
  .legend-item.hidden { opacity: 0.35; }
  .legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 2px;
    flex-shrink: 0;
  }

  /* Load section */
  .load-bar {
    display: flex;
    gap: 8px;
    justify-content: center;
    margin-bottom: 12px;
  }
  .load-bar button {
    padding: 8px 18px;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    color: #555;
    cursor: pointer;
    font-size: 13px;
    transition: background 0.2s, border-color 0.2s;
  }
  .load-bar button:hover { background: #f5f5f5; border-color: #999; }
  .drop-zone {
    max-width: 500px;
    margin: 0 auto;
    padding: 24px;
    border: 2px dashed #ddd;
    border-radius: 12px;
    text-align: center;
    color: #999;
    font-size: 14px;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
  }
  .drop-zone:hover, .drop-zone.dragover { border-color: #4285f4; background: #f0f6ff; }
  .drop-zone input { display: none; }
  .download-btn {
    position: absolute;
    top: 24px;
    right: 32px;
    background: none;
    border: none;
    cursor: pointer;
    color: #999;
    font-size: 18px;
    padding: 4px 8px;
  }
  .download-btn:hover { color: #333; }
</style>
</head>
<body>

<div class="page-header">
  <h1>Combat Level Benchmark
    <span class="view-toggle" id="viewToggle" style="display:none">
      <button data-view="bar" class="active" onclick="setView('bar')">Chart</button>
      <button data-view="runs" onclick="setView('runs')">Runs</button>
      <button data-view="skills" onclick="setView('skills')">Skills</button>
      <button data-view="timeseries" onclick="setView('timeseries')">Timeline</button>
      <button data-view="transcript" onclick="setView('transcript')">Transcript</button>
    </span>
  </h1>
</div>
<div class="page-subtitle" id="pageSubtitle">Best combat level from fresh accounts (30 min agent time, 5 min per run)</div>
<button class="download-btn" onclick="downloadView()" title="Download as PNG">&#8681;</button>

<div id="barContainer" class="bar-container" style="display:none"></div>
<div id="runsContainer" class="runs-container" style="display:none"></div>
<div id="skillsContainer" class="skills-container" style="display:none"></div>
<div id="timeseriesContainer" class="timeseries-container" style="display:none"></div>
<div id="transcriptContainer" class="transcript-container" style="display:none"></div>

<div id="loadSection">
  <div class="load-bar" id="loadBar">
    <button onclick="loadResults()" id="loadBtn">Load Results</button>
  </div>
  <div class="drop-zone" id="dropZone">
    <p>Drop _combined.json here or click to browse</p>
    <input type="file" id="fileInput" accept=".json">
  </div>
</div>

<div class="bottom-legend" id="bottomLegend"></div>

<script>
const MODEL_CONFIG = {
  'opus':     { displayName: 'Claude Opus 4.6',   color: '#8b7355', order: 1, icon: 'model-icons/anthropic.svg' },
  'sonnet46': { displayName: 'Claude Sonnet 4.6', color: '#d4442a', order: 2, icon: 'model-icons/anthropic.svg' },
  'sonnet45': { displayName: 'Claude Sonnet 4.5', color: '#e07850', order: 3, icon: 'model-icons/anthropic.svg' },
  'gemini':   { displayName: 'Gemini 3 Pro',      color: '#4285f4', order: 4, icon: 'model-icons/gemini.webp' },
  'haiku':    { displayName: 'Claude Haiku 3.5',   color: '#e06090', order: 5, icon: 'model-icons/anthropic.svg' },
  'codex':    { displayName: 'Codex CLI 5.2',       color: '#10a37f', order: 6, icon: 'model-icons/openai.png' },
  'codex53':  { displayName: 'Codex CLI 5.3',       color: '#0d8c6b', order: 7, icon: 'model-icons/openai.png' },
  'glm':      { displayName: 'GLM 5',             color: '#6c5ce7', order: 8, icon: 'model-icons/zai.png' },
  'kimi':     { displayName: 'Kimi K2.5',         color: '#00b4d8', order: 9, icon: 'model-icons/kimi.png' },
};

const COMBAT_SKILLS = ['Attack', 'Strength', 'Defence', 'Hitpoints', 'Ranged', 'Prayer', 'Magic'];

let combatData = {};
let currentView = 'bar';
let hiddenModels = new Set();
let barChart = null;
let timeseriesChart = null;

// Preload model icons
const modelIconImages = {};
let iconsLoaded = 0;
let iconTotal = 0;
function preloadIcons() {
  for (const [key, config] of Object.entries(MODEL_CONFIG)) {
    if (config.icon) {
      iconTotal++;
      const img = new Image();
      img.onload = () => {
        iconsLoaded++;
        if (iconsLoaded >= iconTotal) {
          if (barChart) barChart.draw();
          if (timeseriesChart) timeseriesChart.draw();
        }
      };
      img.src = config.icon;
      modelIconImages[key] = img;
    }
  }
}
preloadIcons();

// ── Data loading ────────────────────────────────────────────────

function loadResults() {
  if (window.COMBAT_DATA) {
    combatData = window.COMBAT_DATA;
    onDataLoaded();
  }
}

const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  for (const file of e.dataTransfer.files) {
    const reader = new FileReader();
    reader.onload = (ev) => {
      try { combatData = JSON.parse(ev.target.result); onDataLoaded(); } catch {}
    };
    reader.readAsText(file);
  }
});
fileInput.addEventListener('change', e => {
  for (const file of e.target.files) {
    const reader = new FileReader();
    reader.onload = (ev) => {
      try { combatData = JSON.parse(ev.target.result); onDataLoaded(); } catch {}
    };
    reader.readAsText(file);
  }
});

// ── UI ──────────────────────────────────────────────────────────

function onDataLoaded() {
  document.getElementById('loadSection').style.display = 'none';
  document.getElementById('viewToggle').style.display = '';
  renderLegend();
  renderCurrentView();
}

function setView(view) {
  currentView = view;
  document.querySelectorAll('.view-toggle button').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.view === view);
  });
  renderCurrentView();
}

function toggleModel(name) {
  if (hiddenModels.has(name)) hiddenModels.delete(name);
  else hiddenModels.add(name);
  renderLegend();
  renderCurrentView();
}

function getModelsInData() {
  return Object.keys(combatData)
    .sort((a, b) => ((MODEL_CONFIG[a] || {order:99}).order) - ((MODEL_CONFIG[b] || {order:99}).order));
}

function renderLegend() {
  const models = getModelsInData();
  const el = document.getElementById('bottomLegend');
  el.innerHTML = models.map(name => {
    const config = MODEL_CONFIG[name] || { displayName: name, color: '#999' };
    const isHidden = hiddenModels.has(name);
    return `<div class="legend-item ${isHidden ? 'hidden' : ''}" onclick="toggleModel('${name}')">
      <div class="legend-dot" style="background:${config.color}"></div>
      <span>${config.displayName}</span>
    </div>`;
  }).join('');
}

function renderCurrentView() {
  document.getElementById('barContainer').style.display = 'none';
  document.getElementById('runsContainer').style.display = 'none';
  document.getElementById('skillsContainer').style.display = 'none';
  document.getElementById('timeseriesContainer').style.display = 'none';
  document.getElementById('transcriptContainer').style.display = 'none';

  if (currentView === 'bar') {
    document.getElementById('barContainer').style.display = 'flex';
    renderBar();
  } else if (currentView === 'runs') {
    document.getElementById('runsContainer').style.display = 'block';
    renderRuns();
  } else if (currentView === 'skills') {
    document.getElementById('skillsContainer').style.display = 'block';
    renderSkills();
  } else if (currentView === 'timeseries') {
    document.getElementById('timeseriesContainer').style.display = 'flex';
    renderTimeseries();
  } else if (currentView === 'transcript') {
    document.getElementById('transcriptContainer').style.display = 'flex';
    renderTranscript();
  }
}

// ── Bar Chart View ──────────────────────────────────────────────

function renderBar() {
  if (barChart) { barChart.destroy(); barChart = null; }

  const container = document.getElementById('barContainer');
  container.innerHTML = '';

  const canvas = document.createElement('canvas');
  container.appendChild(canvas);

  const models = getModelsInData().filter(m => !hiddenModels.has(m));

  // Sort by combat level descending for the chart
  const sorted = [...models].sort((a, b) => (combatData[b]?.combatLevel || 0) - (combatData[a]?.combatLevel || 0));

  const labels = sorted.map(m => (MODEL_CONFIG[m] || { displayName: m }).displayName);
  const values = sorted.map(m => combatData[m]?.combatLevel || 0);
  const colors = sorted.map(m => (MODEL_CONFIG[m] || { color: '#999' }).color);

  // Also show run count as secondary info
  const runCounts = sorted.map(m => combatData[m]?.totalRuns || 0);

  barChart = new Chart(canvas, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: colors.map(c => hexToRgba(c, 0.8)),
        borderColor: colors,
        borderWidth: 1.5,
        borderRadius: 4,
        barPercentage: 0.7,
      }],
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 500 },
      layout: { padding: { right: 60 } },
      scales: {
        x: {
          min: 0,
          title: { display: true, text: 'Combat Level', color: '#999', font: { size: 12 } },
          ticks: { color: '#999', font: { size: 11 } },
          grid: { color: '#f0f0f0', drawTicks: false },
          border: { color: '#e0e0e0' },
        },
        y: {
          ticks: { color: '#333', font: { size: 12, weight: '500' } },
          grid: { display: false },
          border: { display: false },
        },
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (item) => {
              const idx = item.dataIndex;
              const model = sorted[idx];
              const runs = runCounts[idx];
              return `Combat Level: ${item.parsed.x} (${runs} run${runs !== 1 ? 's' : ''})`;
            },
          },
        },
      },
    },
    plugins: [{
      id: 'barLabels',
      afterDraw(chart) {
        const ctx = chart.ctx;
        ctx.save();
        ctx.font = '13px -apple-system, sans-serif';
        ctx.fillStyle = '#666';
        ctx.textAlign = 'left';
        ctx.textBaseline = 'middle';

        const meta = chart.getDatasetMeta(0);
        for (let i = 0; i < meta.data.length; i++) {
          const bar = meta.data[i];
          const val = values[i];
          const runs = runCounts[i];
          ctx.fillText(`${val}  (${runs} runs)`, bar.x + 6, bar.y);
        }
        ctx.restore();
      }
    }],
  });
}

// ── Runs View ───────────────────────────────────────────────────

function renderRuns() {
  const container = document.getElementById('runsContainer');
  container.innerHTML = '';

  const models = getModelsInData().filter(m => !hiddenModels.has(m));

  // Sort by best combat level descending
  const sorted = [...models].sort((a, b) => (combatData[b]?.combatLevel || 0) - (combatData[a]?.combatLevel || 0));

  for (const model of sorted) {
    const config = MODEL_CONFIG[model] || { displayName: model, color: '#999', icon: '' };
    const data = combatData[model];
    if (!data) continue;

    const section = document.createElement('div');
    section.className = 'model-runs-section';

    const header = document.createElement('div');
    header.className = 'model-runs-header';
    const iconHtml = config.icon ? `<img src="${config.icon}" onerror="this.style.display='none'">` : '';
    header.innerHTML = `${iconHtml}<span class="model-name" style="color:${config.color}">${config.displayName}</span><span class="model-best">Best: CL ${data.combatLevel}</span>`;
    section.appendChild(header);

    const runs = data.allRuns || [];
    if (runs.length === 0) {
      const p = document.createElement('p');
      p.style.cssText = 'color:#999;font-size:13px;margin-left:26px;';
      p.textContent = 'No run data available';
      section.appendChild(p);
      container.appendChild(section);
      continue;
    }

    let html = '<table class="runs-table"><thead><tr>';
    html += '<th>Run</th><th>CL</th>';
    for (const s of COMBAT_SKILLS) html += `<th>${s.substring(0, 3)}</th>`;
    html += '<th>Duration</th><th>Status</th>';
    html += '</tr></thead><tbody>';

    for (const run of runs) {
      const isBest = run.combatLevel === data.combatLevel && run.combatLevel > 0;
      const rowClass = isBest ? ' class="best-run-row"' : '';

      html += `<tr${rowClass}>`;
      html += `<td class="run-num">#${run.runId}</td>`;

      if (run.error) {
        html += `<td class="cl-cell error-run" colspan="${COMBAT_SKILLS.length + 2}">${run.error}</td>`;
      } else {
        const clClass = isBest ? 'cl-cell best-run' : 'cl-cell';
        html += `<td class="${clClass}" style="color:${config.color}">${run.combatLevel}</td>`;
        for (const s of COMBAT_SKILLS) {
          const level = run.skills?.[s]?.level ?? 1;
          const cellClass = level > 1 ? '' : ' style="color:#ccc"';
          html += `<td class="skill-cell"${cellClass}>${level}</td>`;
        }
        const durSec = (run.durationMs / 1000).toFixed(0);
        html += `<td class="skill-cell">${durSec}s</td>`;
        html += `<td class="skill-cell">${run.scriptExitCode === 0 ? 'OK' : `exit ${run.scriptExitCode}`}</td>`;
      }
      html += '</tr>';
    }

    html += '</tbody></table>';
    section.innerHTML += html;
    container.appendChild(section);
  }
}

// ── Skills Heatmap View ─────────────────────────────────────────

function renderSkills() {
  const container = document.getElementById('skillsContainer');
  const models = getModelsInData().filter(m => !hiddenModels.has(m));

  // Sort by best combat level descending
  const sorted = [...models].sort((a, b) => (combatData[b]?.combatLevel || 0) - (combatData[a]?.combatLevel || 0));

  // Find max level per skill across all models (for heatmap intensity)
  const skillMax = {};
  for (const s of COMBAT_SKILLS) {
    let max = 1;
    for (const model of sorted) {
      const best = combatData[model]?.bestRun;
      if (best?.skills?.[s]) {
        const lvl = best.skills[s].level || 1;
        if (lvl > max) max = lvl;
      }
    }
    skillMax[s] = max;
  }

  let html = '<table class="skills-table"><thead><tr><th class="model-header">Model</th><th>CL</th>';
  for (const s of COMBAT_SKILLS) html += `<th>${s}</th>`;
  html += '<th>Runs</th>';
  html += '</tr></thead><tbody>';

  for (const model of sorted) {
    const config = MODEL_CONFIG[model] || { displayName: model, color: '#999' };
    const data = combatData[model];
    if (!data) continue;
    const best = data.bestRun;

    html += `<tr><td class="model-cell" style="color:${config.color}">${config.displayName}</td>`;
    html += `<td class="heatmap-cell" style="font-size:18px;font-weight:700;color:${config.color}">${data.combatLevel}</td>`;

    for (const s of COMBAT_SKILLS) {
      const level = best?.skills?.[s]?.level ?? 1;
      const xp = best?.skills?.[s]?.xp ?? 0;
      const max = skillMax[s];
      const intensity = max > 1 ? (level - 1) / (max - 1) : 0;

      const alpha = Math.max(0.05, intensity * 0.5);
      const bg = hexToRgba(config.color, alpha);
      const textColor = intensity > 0.3 ? config.color : '#888';
      const fontWeight = intensity >= 0.99 ? '700' : '500';

      html += `<td class="heatmap-cell" style="background:${bg};color:${textColor};font-weight:${fontWeight}">`;
      if (level > 1) {
        html += `<div class="level-value">${level}</div>`;
        html += `<div class="xp-value">${formatXp(xp)}</div>`;
      } else {
        html += '<div class="level-value" style="color:#ddd">&mdash;</div>';
      }
      html += '</td>';
    }

    html += `<td style="text-align:center;color:#999;font-size:13px">${data.totalRuns}</td>`;
    html += '</tr>';
  }

  html += '</tbody></table>';
  container.innerHTML = html;
}

// ── Timeseries View ─────────────────────────────────────────────

function renderTimeseries() {
  if (timeseriesChart) { timeseriesChart.destroy(); timeseriesChart = null; }

  const container = document.getElementById('timeseriesContainer');
  container.innerHTML = '';

  const models = getModelsInData().filter(m => !hiddenModels.has(m));

  // Check if any model has samples data
  let hasSamples = false;
  for (const model of models) {
    const runs = combatData[model]?.allRuns || [];
    for (const run of runs) {
      if (run.samples && run.samples.length > 0) {
        hasSamples = true;
        break;
      }
    }
    if (hasSamples) break;
  }

  if (!hasSamples) {
    // Fall back to showing per-run combat levels as a simple progression
    const canvas = document.createElement('canvas');
    container.appendChild(canvas);

    const datasets = [];
    const sorted = [...models].sort((a, b) => (combatData[b]?.combatLevel || 0) - (combatData[a]?.combatLevel || 0));

    for (const model of sorted) {
      const config = MODEL_CONFIG[model] || { displayName: model, color: '#999' };
      const runs = combatData[model]?.allRuns || [];
      if (runs.length === 0) continue;

      const points = runs
        .filter(r => !r.error)
        .map(r => ({ x: r.runId, y: r.combatLevel }));

      if (points.length === 0) continue;

      datasets.push({
        label: config.displayName,
        data: points,
        borderColor: config.color,
        backgroundColor: config.color,
        fill: false,
        pointRadius: 5,
        pointHoverRadius: 7,
        borderWidth: 2,
        tension: 0,
        _modelKey: model,
      });
    }

    timeseriesChart = new Chart(canvas, {
      type: 'line',
      data: { datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 500 },
        layout: { padding: { top: 10, right: 24, bottom: 2 } },
        interaction: { mode: 'nearest', intersect: false },
        scales: {
          x: {
            type: 'linear',
            min: 0,
            ticks: { color: '#999', font: { size: 11 }, stepSize: 1, callback: v => `Run ${v}` },
            grid: { color: '#f0f0f0', drawTicks: false },
            border: { color: '#e0e0e0' },
            title: { display: true, text: 'Run Number', color: '#999', font: { size: 12 } },
          },
          y: {
            min: 0,
            ticks: { color: '#999', font: { size: 11 }, maxTicksLimit: 10 },
            grid: { color: '#f0f0f0', drawTicks: false },
            border: { color: '#e0e0e0' },
            title: { display: true, text: 'Combat Level', color: '#999', font: { size: 12 } },
          },
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              title: items => items[0] ? `Run #${items[0].parsed.x}` : '',
              label: item => `${item.dataset.label}: CL ${item.parsed.y}`,
            },
          },
        },
      },
    });
    return;
  }

  // Full time-series view with samples
  const canvas = document.createElement('canvas');
  container.appendChild(canvas);

  const datasets = [];
  const sorted = [...models].sort((a, b) => (combatData[b]?.combatLevel || 0) - (combatData[a]?.combatLevel || 0));

  for (const model of sorted) {
    const config = MODEL_CONFIG[model] || { displayName: model, color: '#999' };
    const runs = combatData[model]?.allRuns || [];

    for (let i = 0; i < runs.length; i++) {
      const run = runs[i];
      if (!run.samples || run.samples.length === 0 || run.error) continue;

      const points = run.samples.map(s => ({
        x: s.elapsedMs / 60000,
        y: s.combatLevel,
      }));

      // Lighter color for non-best runs
      const isBest = run.combatLevel === combatData[model]?.combatLevel;
      const alpha = isBest ? 1 : 0.4;
      const width = isBest ? 2.5 : 1.5;

      datasets.push({
        label: `${config.displayName} #${run.runId}${isBest ? ' (best)' : ''}`,
        data: points,
        borderColor: hexToRgba(config.color, alpha),
        backgroundColor: config.color,
        fill: false,
        stepped: 'after',
        pointRadius: 0,
        pointHoverRadius: 3,
        borderWidth: width,
        tension: 0,
        _modelKey: model,
      });
    }
  }

  timeseriesChart = new Chart(canvas, {
    type: 'line',
    data: { datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 500 },
      layout: { padding: { top: 10, right: 24, bottom: 2 } },
      interaction: { mode: 'nearest', intersect: false },
      scales: {
        x: {
          type: 'linear',
          min: 0,
          max: 5,
          ticks: { color: '#999', font: { size: 11 }, stepSize: 1, callback: v => v + ' min' },
          grid: { color: '#f0f0f0', drawTicks: false },
          border: { color: '#e0e0e0' },
          title: { display: true, text: 'Elapsed Time (per run)', color: '#999', font: { size: 12 } },
        },
        y: {
          min: 0,
          ticks: { color: '#999', font: { size: 11 }, maxTicksLimit: 10 },
          grid: { color: '#f0f0f0', drawTicks: false },
          border: { color: '#e0e0e0' },
          title: { display: true, text: 'Combat Level', color: '#999', font: { size: 12 } },
        },
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            title: items => items[0] ? `${items[0].parsed.x.toFixed(1)} min` : '',
            label: item => `${item.dataset.label}: CL ${item.parsed.y}`,
          },
        },
      },
    },
  });
}

// ── Transcript View ─────────────────────────────────────────────

function renderTranscript() {
  const container = document.getElementById('transcriptContainer');
  container.innerHTML = '';

  const models = getModelsInData().filter(m => !hiddenModels.has(m));
  const sorted = [...models].sort((a, b) => (combatData[b]?.combatLevel || 0) - (combatData[a]?.combatLevel || 0));

  for (const model of sorted) {
    const config = MODEL_CONFIG[model] || { displayName: model, color: '#999', icon: '' };
    const data = combatData[model];
    if (!data) continue;

    const transcript = data.transcript || [];
    const section = document.createElement('div');
    section.className = 'transcript-model';

    const header = document.createElement('div');
    header.className = 'transcript-header';
    const iconHtml = config.icon ? `<img src="${config.icon}" onerror="this.style.display='none'">` : '';
    header.innerHTML = `${iconHtml}<span class="model-name" style="color:${config.color}">${config.displayName}</span>` +
      `<span class="model-meta">CL ${data.combatLevel} &middot; ${transcript.length} messages</span>` +
      `<span class="expand-icon">&#9660;</span>`;

    const body = document.createElement('div');
    body.className = 'transcript-body';

    if (transcript.length === 0) {
      body.innerHTML = '<div class="transcript-msg" style="color:#999;font-style:italic">No transcript available</div>';
    } else {
      for (let i = 0; i < transcript.length; i++) {
        const msg = document.createElement('div');
        msg.className = 'transcript-msg';
        msg.innerHTML = `<span class="transcript-msg-idx">${i + 1}</span>${escapeHtml(transcript[i])}`;
        body.appendChild(msg);
      }
    }

    header.addEventListener('click', () => {
      header.classList.toggle('collapsed');
      body.classList.toggle('collapsed');
    });

    section.appendChild(header);
    section.appendChild(body);
    container.appendChild(section);
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ── Helpers ─────────────────────────────────────────────────────

function formatXp(xp) {
  if (xp >= 1_000_000) return (xp / 1_000_000).toFixed(1) + 'M';
  if (xp >= 1_000) return (xp / 1_000).toFixed(1) + 'k';
  return String(xp);
}

function hexToRgba(hex, alpha) {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  return `rgba(${r},${g},${b},${alpha})`;
}

function downloadView() {
  if (currentView === 'bar' && barChart) {
    const link = document.createElement('a');
    link.download = 'combat-level-benchmark.png';
    link.href = barChart.canvas.toDataURL('image/png', 1.0);
    link.click();
  } else if (currentView === 'timeseries' && timeseriesChart) {
    const link = document.createElement('a');
    link.download = 'combat-level-timeline.png';
    link.href = timeseriesChart.canvas.toDataURL('image/png', 1.0);
    link.click();
  }
}

// Auto-load on page open
loadResults();
</script>
</body>
</html>
